@model IEnumerable<DomainModel.ViewModel.MessageListItem>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";

}


<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="~/Content/Site.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-3.3.1.min.js"></script>
    <script src="../Scripts/jquery.signalR-2.3.0.min.js"></script>
    <script src="../SignalR/Hubs/"></script>


    <script>
        var Globalreceiver_id;
        function getAllMessages (id, messageType)
        {

            Globalreceiver_id = id;
            var sr = 
                {
                    type:messageType,
                    user_id: $('#username').val(),
                    receiver_id: id
                };
            debugger;
            $.ajax({

                type: "Get",
                url: 'http://localhost:1612/api/Chat/?user_id='+sr.user_id+'&&receiver_id='+sr.receiver_id,
                datatype: JSON,
                data: JSON.stringify(sr),// pass json object to web api
                success:function(messages)
                {
                    //alert("successful retreival")
                    //debugger;

                    $('#content').empty()
                    $.each(messages, function (index,data) {
                        let messageString =
                    '<b>' + data.user_name + ':</b> ' + data.message_text + '<br />'
                        $('#content').append(messageString)

                    });
                }
            })
        };
        $(function getAllUsers() {
            $.ajax({

                type: "Get",
                url: 'http://localhost:1612/api/User/',
                datatype: JSON,
                success: function (users) {
                    //debugger;

                    $.each(users, function (index, user) {
                      
                        let userInfo =
                      '<li onClick="getAllMessages(\'' + user.user_id+ '\',0)">' + user.username + '-' + user.status + '</li>'

                        $('#contacts').append(userInfo)

                    });
                }
            })
        });


       

        function SendMessage() {
            var message = {

                message_text: $('#txtMessage').val(),
                user_id: $('#username').val(),
                receiver_id:Globalreceiver_id
            };
            $.ajax({
                type: "POST",
                url: 'http://localhost:1612/api/Chat/',//change to your url
                data: JSON.stringify(message),// pass json object to web api
                contentType: 'application/json',
                success: function () {
                    //alert('success!');
                    $("#txtMessage").empty();
                    $(function () {

                        // Declare a proxy to reference the hub.
                        let chatHubProxy =
                            $.connection.chatHub

                        $.connection.hub.start()

                            .done(function () {

                                console.log($.connection.hub.id)

                                //$('#content').prepend('<br />Connection Started!')

                                let message = $('#txtMessage').val()
                                let userid = $('#username').val()

                                // Call the [SendMessage] method in the [ChatHub] class in server.
                                console.log(message)
                                chatHubProxy.server.sendMessage(userid, message)

                            })

                            .fail(function () {

                                console.log('Could not Connect!')

                            })
                    });

                }
            });

        }

        // Create a javascript (client) function (method) for broadcasting by server.
        $(function () {
            let chatHubProxy =
                    $.connection.chatHub
            chatHubProxy.client.broadcastMessage = function (name, message) {
                //debugger;               //helps debugging the code
                //alert("This is the message" + message)
                let messageString =
                    '<br /><b>' + name + ':</b> ' + message
                $('#content').append(messageString)

            }
        });

        
    </script>
</head>
<body>
    <div class="container">
        <div>
            <input type="text" id="username"  class="form-control"/>
        </div>
        <h4>Contacts</h4>
        <div id="contacts" class="col-sm-4 inlineDiv">
            <ul id="contactlistul">
            </ul>
        </div>

        <h4>Rooms</h4>
        <div id="rooms" class="col-sm-4 inlineDiv">
            <ul id="roomList"></ul>
        </div>



        <div class="form-group col-sm-8">

            <div id="content" class=" messageHistory">
                @*@foreach (var item in Model)
                {
                    @Html.DisplayFor(model=>item.user_name)
                    <span>:</span>
                    @Html.DisplayFor(model=>item.message_text)
                    <br />
                }*@
            </div>
            <br />

            <div class=" text-center">
                <div class="input-group FullWidth">
                    <input type="text" id="txtMessage" class="form-control " />
                </div>

                <br />
                <div class="form-group">
                    <input type="button" value="Send" class="btn btn-success" onclick="SendMessage()" />
                </div>
            </div>

        </div>
    </div>

</body>
</html>
